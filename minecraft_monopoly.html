<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸–ç•Œå¤§å¯Œç¿ - Minecraft Monopoly</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #fff;
        }

        /* æ˜Ÿç©ºèƒŒæ™¯ */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* æ¸¸æˆå®¹å™¨ */
        #gameContainer {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00;
            background: linear-gradient(45deg, #00ff00, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ä¸»èœå• */
        #mainMenu {
            text-align: center;
            padding: 50px;
        }

        .menu-btn {
            display: block;
            width: 280px;
            margin: 20px auto;
            padding: 18px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .menu-btn:hover::before {
            left: 100%;
        }

        .btn-single {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-double {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .btn-rules {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .menu-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* æ¸¸æˆåŒºåŸŸ */
        #gameArea {
            display: none;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }

        /* å¹³é¢æ£‹ç›˜å®¹å™¨ */
        .board-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .board {
            width: 640px;
            height: 640px;
            background: linear-gradient(135deg, #2d5016, #1a3009);
            border-radius: 20px;
            box-shadow:
                0 0 0 8px #5d4037,
                0 0 0 12px #3e2723,
                0 20px 60px rgba(0,0,0,0.5);
            position: relative;
        }

        /* è‰åœ°çº¹ç†èƒŒæ™¯ */
        .board::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(0,0,0,0.03) 20px, rgba(0,0,0,0.03) 22px),
                repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(0,0,0,0.03) 20px, rgba(0,0,0,0.03) 22px);
            border-radius: 12px;
            pointer-events: none;
            z-index: 0;
        }

        /* ä¸­å¿ƒåŒºåŸŸ - ä½äºæ£‹ç›˜ä¸­å¤®ï¼Œé¿å¼€å¤–å›´æ ¼å­ */
        .board-center {
            position: absolute;
            top: 114px;
            left: 114px;
            width: 412px;
            height: 412px;
            background: linear-gradient(135deg, #87CEEB 0%, #5dade2 50%, #3498db 100%);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.2);
            z-index: 1;
            overflow: hidden;
        }

        /* äº‘æœµè£…é¥° */
        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.6);
            border-radius: 50px;
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
        }

        .cloud1 {
            width: 60px;
            height: 20px;
            top: 30px;
            left: 30px;
        }

        .cloud1::before {
            width: 30px;
            height: 30px;
            top: -15px;
            left: 8px;
        }

        .cloud1::after {
            width: 25px;
            height: 25px;
            top: -10px;
            right: 8px;
        }

        .cloud2 {
            width: 50px;
            height: 18px;
            bottom: 40px;
            right: 40px;
        }

        .cloud2::before {
            width: 25px;
            height: 25px;
            top: -12px;
            left: 6px;
        }

        .cloud2::after {
            width: 20px;
            height: 20px;
            top: -8px;
            right: 6px;
        }

        .center-logo {
            font-size: 3.5em;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            z-index: 2;
        }

        .center-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-top: 10px;
            z-index: 2;
        }

        /* æ ¼å­æ ·å¼ - ç»å¯¹å®šä½ */
        .cell {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding: 4px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow:
                0 3px 6px rgba(0,0,0,0.16),
                0 3px 6px rgba(0,0,0,0.23),
                inset 0 1px 0 rgba(255,255,255,0.8);
            border: 2px solid #ccc;
            z-index: 10;
        }

        .cell:hover {
            transform: scale(1.08) translateY(-3px);
            box-shadow:
                0 8px 15px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.9);
            z-index: 10;
        }

        .cell-icon {
            font-size: 2em;
            margin-bottom: 2px;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
        }

        .cell-name {
            font-size: 9px;
            line-height: 1.2;
            color: #333;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        .cell-price {
            font-size: 10px;
            color: #2e7d32;
            font-weight: bold;
            margin-top: 2px;
        }

        /* ç‰¹æ®Šæ ¼å­æ ·å¼ */
        .cell-start {
            background: linear-gradient(145deg, #FFD700, #FFA000);
            border-color: #FF8F00;
        }
        .cell-start .cell-name { color: #5d4037; }

        .cell-jail {
            background: linear-gradient(145deg, #78909c, #546e7a);
            border-color: #455a64;
        }
        .cell-jail .cell-name { color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        .cell-chance {
            background: linear-gradient(145deg, #E1BEE7, #CE93D8);
            border-color: #AB47BC;
        }
        .cell-chance .cell-name { color: #4A148C; }

        .cell-chest {
            background: linear-gradient(145deg, #B2EBF2, #80DEEA);
            border-color: #00BCD4;
        }
        .cell-chest .cell-name { color: #006064; }

        .cell-tax {
            background: linear-gradient(145deg, #FFCDD2, #EF9A9A);
            border-color: #EF5350;
        }
        .cell-tax .cell-name { color: #B71C1C; }

        .cell-go-jail {
            background: linear-gradient(145deg, #424242, #212121);
            border-color: #000;
        }
        .cell-go-jail .cell-name { color: #fff; }

        /* åœ°äº§æ ¼å­é¢œè‰²ç»„ - å¢å¼ºæ ‡è¯† */
        .cell-group-1 {
            border-top: 8px solid #8D6E63;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
        }
        .cell-group-1 .cell-name {
            color: #5D4037;
            font-weight: bold;
        }

        .cell-group-2 {
            border-top: 8px solid #42A5F5;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
        }
        .cell-group-2 .cell-name {
            color: #1565C0;
            font-weight: bold;
        }

        .cell-group-3 {
            border-top: 8px solid #AB47BC;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
        }
        .cell-group-3 .cell-name {
            color: #7B1FA2;
            font-weight: bold;
        }

        .cell-group-4 {
            border-top: 8px solid #FF7043;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
        }
        .cell-group-4 .cell-name {
            color: #D84315;
            font-weight: bold;
        }

        .cell-group-5 {
            border-top: 8px solid #FFEE58;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
        }
        .cell-group-5 .cell-name {
            color: #F57F17;
            font-weight: bold;
        }

        .cell-group-6 {
            border-top: 8px solid #66BB6A;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
        }
        .cell-group-6 .cell-name {
            color: #2E7D32;
            font-weight: bold;
        }

        /* åˆ†ç»„æ ‡è¯†æ ‡ç­¾ */
        .group-badge {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-weight: bold;
        }

        .cell-group-1 .group-badge { background: #8D6E63; }
        .cell-group-2 .group-badge { background: #42A5F5; }
        .cell-group-3 .group-badge { background: #AB47BC; }
        .cell-group-4 .group-badge { background: #FF7043; }
        .cell-group-5 .group-badge { background: #FBC02D; color: #333; }
        .cell-group-6 .group-badge { background: #66BB6A; }

        /* è§’è½æ ¼å­ */
        .cell-corner {
            grid-column: span 1;
            grid-row: span 1;
        }

        .cell-corner .cell-icon {
            font-size: 2.5em;
        }

        .cell-corner .cell-name {
            font-size: 11px;
        }

        /* ç©å®¶æ£‹å­ - å¹³é¢ç‰ˆæœ¬ */
        .player {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow:
                0 4px 8px rgba(0,0,0,0.5),
                0 0 0 4px rgba(255,255,255,0.9),
                0 0 0 6px rgba(0,0,0,0.3),
                inset 0 -3px 8px rgba(0,0,0,0.3),
                inset 0 3px 8px rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            /* åˆå§‹ä½ç½®è®¾ä¸ºéšè—ï¼Œç­‰æ­£ç¡®ä½ç½®è®¡ç®—åå†æ˜¾ç¤º */
            left: -100px;
            top: -100px;
        }

        .p1 {
            background: radial-gradient(circle at 35% 35%, #ff6b6b, #c92a2a);
        }

        .p2 {
            background: radial-gradient(circle at 35% 35%, #4dabf7, #1864ab);
        }

        .p3 {
            background: radial-gradient(circle at 35% 35%, #c084fc, #7e22ce);
        }

        .p4 {
            background: radial-gradient(circle at 35% 35%, #fb923c, #ea580c);
        }

        .p5 {
            background: radial-gradient(circle at 35% 35%, #22d3ee, #0891b2);
        }

        .p6 {
            background: radial-gradient(circle at 35% 35%, #a3e635, #65a30d);
        }

        .ai {
            background: radial-gradient(circle at 35% 35%, #ffa94d, #d9480f);
        }

        /* æ‰€æœ‰æƒæ ‡è®° */
        .owner-mark {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            top: 4px;
            right: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 2px solid #fff;
            z-index: 5;
        }

        .owner-mark::after {
            content: 'â˜…';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            color: #fff;
        }

        /* æˆ¿å±‹æ ‡è®° */
        .house-markers {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            z-index: 6;
        }

        .house-marker {
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #ff6b6b, #c92a2a);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid #fff;
        }

        .house-hotel {
            width: 16px;
            height: 12px;
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            border: 1px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #fff;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            background: rgba(0,0,0,0.6);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .player-info {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid;
            transition: all 0.3s;
        }

        .player-info.active {
            background: rgba(255,255,255,0.2);
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
            transform: scale(1.02);
        }

        .player-info.p1 { border-color: #ff4444; }
        .player-info.p2 { border-color: #4444ff; }
        .player-info.p3 { border-color: #9c27b0; }
        .player-info.p4 { border-color: #ff5722; }
        .player-info.p5 { border-color: #00bcd4; }
        .player-info.p6 { border-color: #8bc34a; }
        .player-info.ai { border-color: #ff8800; }

        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid #fff;
        }

        .player-money {
            font-size: 1.2em;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .player-position {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }

        .player-properties {
            margin-top: 10px;
            font-size: 0.85em;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .property-tag {
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        /* æ§åˆ¶åŒº */
        .controls {
            margin-top: 20px;
            text-align: center;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .dice {
            width: 70px;
            height: 70px;
            background: linear-gradient(145deg, #fff, #e0e0e0);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            color: #333;
            box-shadow:
                0 8px 16px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.8);
            transition: transform 0.3s;
            border: 2px solid #ccc;
        }

        .dice.rolling {
            animation: roll 0.4s ease infinite;
        }

        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .control-btn {
            padding: 14px 32px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 8px 5px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .btn-roll {
            background: linear-gradient(135deg, #66BB6A, #43A047);
            color: white;
        }

        .btn-buy {
            background: linear-gradient(135deg, #42A5F5, #1E88E5);
            color: white;
        }

        .btn-build {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-end {
            background: linear-gradient(135deg, #EF5350, #D32F2F);
            color: white;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .control-btn:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        /* æ¸¸æˆæ—¥å¿— */
        .game-log {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry {
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 0.9em;
            line-height: 1.4;
            border-left: 3px solid transparent;
        }

        .log-entry.system {
            color: #aaa;
            background: rgba(255,255,255,0.05);
        }
        .log-entry.p1 {
            color: #ff8888;
            background: rgba(255,68,68,0.1);
            border-left-color: #ff4444;
        }
        .log-entry.p2 {
            color: #8888ff;
            background: rgba(68,68,255,0.1);
            border-left-color: #4444ff;
        }
        .log-entry.p3 {
            color: #ce93d8;
            background: rgba(156,39,176,0.1);
            border-left-color: #9c27b0;
        }
        .log-entry.p4 {
            color: #ffab91;
            background: rgba(255,87,34,0.1);
            border-left-color: #ff5722;
        }
        .log-entry.p5 {
            color: #80deea;
            background: rgba(0,188,212,0.1);
            border-left-color: #00bcd4;
        }
        .log-entry.p6 {
            color: #c5e1a5;
            background: rgba(139,195,74,0.1);
            border-left-color: #8bc34a;
        }
        .log-entry.ai {
            color: #ffaa44;
            background: rgba(255,136,0,0.1);
            border-left-color: #ff8800;
        }
        .log-entry.event {
            color: #FFD700;
            background: rgba(255,215,0,0.1);
            border-left-color: #FFD700;
        }

        /* äº¤æ˜“æŒ‰é’® */
        .btn-trade {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
        }

        /* äº¤æ˜“å¼¹çª—æ ·å¼ */
        .trade-modal {
            max-width: 700px !important;
            width: 90%;
        }

        .trade-confirm-modal {
            max-width: 500px !important;
        }

        .trade-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .trade-side {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
        }

        .trade-side h3 {
            margin-bottom: 15px;
            color: #FFD700;
            font-size: 1.1em;
        }

        .trade-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .trade-section {
            margin-bottom: 15px;
        }

        .trade-section label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }

        .trade-input {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1em;
        }

        .trade-select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1em;
            cursor: pointer;
        }

        .trade-properties {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px;
        }

        .trade-property-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trade-property-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .trade-property-item.selected {
            background: rgba(76,175,80,0.4);
            border: 2px solid #4CAF50;
        }

        .trade-property-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .trade-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .btn-confirm {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
        }

        .trade-details {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            text-align: left;
        }

        .trade-details h4 {
            color: #FFD700;
            margin-bottom: 10px;
        }

        .trade-details-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 20px;
            padding: 35px;
            max-width: 450px;
            text-align: center;
            animation: modalIn 0.3s ease;
            border: 4px solid;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        @keyframes modalIn {
            from { transform: scale(0.8) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-content.chance { border-color: #E040FB; }
        .modal-content.chest { border-color: #00BCD4; }
        .modal-content.tax { border-color: #f44336; }
        .modal-content.jail { border-color: #616161; }
        .modal-content.win { border-color: #FFD700; }
        .modal-content.normal { border-color: #4CAF50; }

        .modal h2 {
            margin-bottom: 20px;
            font-size: 1.9em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .modal-icon {
            font-size: 4.5em;
            margin: 25px 0;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .modal-text {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #ecf0f1;
        }

        .modal-btn {
            padding: 12px 35px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #66BB6A, #43A047);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        /* è§„åˆ™é¡µé¢ */
        #rulesPage {
            display: none;
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 35px;
            max-width: 850px;
            margin: 0 auto;
            border: 2px solid rgba(255,255,255,0.1);
        }

        #rulesPage h2 {
            color: #FFD700;
            margin-bottom: 25px;
            font-size: 2em;
            text-align: center;
        }

        #rulesPage ul {
            text-align: left;
            line-height: 2;
            list-style: none;
        }

        #rulesPage li {
            margin: 15px 0;
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        #rulesPage li strong {
            color: #FFD700;
        }

        .back-btn {
            margin-top: 25px;
            padding: 14px 45px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        /* æ‚¬æµ®æç¤º */
        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 220px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }

        .tooltip-title {
            font-size: 14px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 6px;
        }

        .tooltip-info {
            line-height: 1.5;
        }

        /* ç²’å­æ•ˆæœ */
        .particle {
            position: fixed;
            pointer-events: none;
            z-index: 999;
        }

        /* å½“å‰ç©å®¶æ ‡è®° */
        .current-turn {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFD700;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 60;
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            #gameArea {
                grid-template-columns: 1fr;
            }

            .board {
                width: 440px;
                height: 440px;
            }

            .board-center {
                top: 80px;
                left: 80px;
                width: 278px;
                height: 278px;
            }

            .cell {
                width: 68px;
                height: 68px;
            }

            .cell-icon {
                font-size: 1.4em;
            }

            .cell-name {
                font-size: 7px;
            }

            .player {
                width: 28px;
                height: 28px;
                font-size: 10px;
            }

            .center-logo {
                font-size: 2em;
            }

            .center-text {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="stars" id="stars"></div>

    <div id="gameContainer">
        <h1>ğŸ° æˆ‘çš„ä¸–ç•Œå¤§å¯Œç¿ ğŸ°</h1>
        <div style="text-align: center; color: #aaa; font-size: 0.9em; margin-top: -15px; margin-bottom: 20px; letter-spacing: 2px;">designed by Ray</div>

        <!-- ä¸»èœå• -->
        <div id="mainMenu">
            <div style="margin-bottom: 10px; color: #FFD700; font-size: 1.1em;">é€‰æ‹©æ¸¸æˆæ¨¡å¼</div>
            <button class="menu-btn btn-single" onclick="startGame(1)">ğŸ® å•äººæ¸¸æˆ (1äºº vs AI)</button>
            <div style="margin: 15px 0; color: #aaa; font-size: 0.9em;">å¤šäººå¯¹æˆ˜</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 400px; margin: 0 auto;">
                <button class="menu-btn btn-double" onclick="startGame(2)" style="width: auto; padding: 12px;">ğŸ‘¥ 2äºº</button>
                <button class="menu-btn" onclick="startGame(3)" style="width: auto; padding: 12px; background: linear-gradient(135deg, #9C27B0, #7B1FA2);">ğŸ‘¥ 3äºº</button>
                <button class="menu-btn" onclick="startGame(4)" style="width: auto; padding: 12px; background: linear-gradient(135deg, #FF5722, #E64A19);">ğŸ‘¥ 4äºº</button>
                <button class="menu-btn" onclick="startGame(5)" style="width: auto; padding: 12px; background: linear-gradient(135deg, #00BCD4, #0097A7);">ğŸ‘¥ 5äºº</button>
                <button class="menu-btn" onclick="startGame(6)" style="width: auto; padding: 12px; background: linear-gradient(135deg, #8BC34A, #689F38);">ğŸ‘¥ 6äºº</button>
            </div>
            <button class="menu-btn btn-rules" onclick="showRules()" style="margin-top: 20px;">ğŸ“œ æ¸¸æˆè§„åˆ™</button>
        </div>

        <!-- è§„åˆ™é¡µé¢ -->
        <div id="rulesPage">
            <h2>ğŸ“œ æ¸¸æˆè§„åˆ™</h2>
            <ul>
                <li><strong>ğŸƒ ç§»åŠ¨ï¼š</strong>æ·éª°å­å‰è¿›ï¼Œæ ¹æ®ç‚¹æ•°ç§»åŠ¨åˆ°ç›¸åº”ä½ç½®</li>
                <li><strong>ğŸ  è´­ä¹°åœ°äº§ï¼š</strong>åœç•™åœ¨ç©ºåœ°æ—¶å¯ä»¥è´­ä¹°ï¼Œæ‹¥æœ‰åå…¶ä»–ç©å®¶åœç•™éœ€æ”¯ä»˜ç§Ÿé‡‘</li>
                <li><strong>ğŸ—ï¸ å»ºé€ æˆ¿å±‹ï¼š</strong>æ‹¥æœ‰å®Œæ•´é¢œè‰²ç»„å¯ä»¥å»ºé€ æˆ¿å±‹å¢åŠ ç§Ÿé‡‘</li>
                <li><strong>â“ æœºä¼šï¼š</strong>ç´«è‰²æ ¼å­è§¦å‘éšæœºäº‹ä»¶ï¼Œå¯èƒ½è·å¾—å¥–åŠ±æˆ–å—åˆ°æƒ©ç½š</li>
                <li><strong>ğŸ“¦ å®è—ï¼š</strong>é’è‰²æ ¼å­è·å¾—éšæœºå¥–åŠ±</li>
                <li><strong>â›“ï¸ ç›‘ç‹±ï¼š</strong>ç°è‰²æ ¼å­ï¼Œåœç•™ä¸€å›åˆæˆ–æ”¯ä»˜ä¿é‡Šé‡‘</li>
                <li><strong>ğŸ’° ç¨æ”¶ï¼š</strong>çº¢è‰²æ ¼å­éœ€è¦ç¼´çº³ç¨æ¬¾</li>
                <li><strong>ğŸš” å…¥ç‹±ï¼š</strong>é»‘è‰²æ ¼å­ç›´æ¥é€å…¥ç›‘ç‹±</li>
                <li><strong>ğŸ¯ èƒœåˆ©æ¡ä»¶ï¼š</strong>å…¶ä»–ç©å®¶ç ´äº§å³è·èƒœï¼</li>
            </ul>
            <div style="text-align: center;">
                <button class="back-btn" onclick="hideRules()">è¿”å›ä¸»èœå•</button>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div id="gameArea">
            <div class="board-container">
                <div class="board" id="board">
                    <!-- ä¸­å¿ƒåŒºåŸŸ -->
                    <div class="board-center">
                        <div class="cloud cloud1"></div>
                        <div class="cloud cloud2"></div>
                        <div class="center-logo">â›ï¸</div>
                        <div class="center-text">MINECRAFT<br>MONOPOLY</div>
                    </div>
                    <!-- æ ¼å­å°†é€šè¿‡JSç”Ÿæˆ -->
                </div>
            </div>

            <div class="sidebar">
                <div id="playerInfos"></div>

                <div class="controls">
                    <div class="dice-container">
                        <div class="dice" id="dice1">ğŸ²</div>
                        <div class="dice" id="dice2">ğŸ²</div>
                    </div>
                    <button class="control-btn btn-roll" id="rollBtn" onclick="rollDice()">ğŸ² æ·éª°å­</button>
                    <button class="control-btn btn-buy" id="buyBtn" onclick="buyProperty()" disabled>ğŸ’° è´­ä¹°åœ°äº§</button>
                    <button class="control-btn btn-build" id="buildBtn" onclick="buildHouse()" disabled>ğŸ  å»ºé€ æˆ¿å±‹</button>
                    <button class="control-btn btn-trade" id="tradeBtn" onclick="openTradeModal()" disabled>ğŸ¤ å‘èµ·äº¤æ˜“</button>
                    <button class="control-btn btn-end" id="endBtn" onclick="endTurn()" disabled>â­ï¸ ç»“æŸå›åˆ</button>
                </div>

                <div class="game-log" id="gameLog">
                    <div class="log-entry system">æ¸¸æˆå¼€å§‹ï¼</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <h2 id="modalTitle"></h2>
            <div class="modal-icon" id="modalIcon"></div>
            <p class="modal-text" id="modalText"></p>
            <button class="modal-btn" onclick="closeModal()">ç¡®å®š</button>
        </div>
    </div>

    <!-- æ‚¬æµ®æç¤º -->
    <div class="tooltip" id="tooltip"></div>

    <!-- äº¤æ˜“å¼¹çª— -->
    <div class="modal" id="tradeModal">
        <div class="modal-content trade-modal" id="tradeModalContent">
            <h2>ğŸ¤ å‘èµ·äº¤æ˜“</h2>
            <div class="trade-container">
                <!-- å·¦ä¾§ï¼šæˆ‘çš„å‡ºä»· -->
                <div class="trade-side">
                    <h3>ä½ çš„å‡ºä»·</h3>
                    <div class="trade-section">
                        <label>ğŸ’° é‡‘é¢:</label>
                        <input type="number" id="tradeOfferMoney" min="0" max="1500" value="0" class="trade-input">
                    </div>
                    <div class="trade-section">
                        <label>ğŸ  åœ°äº§:</label>
                        <div id="tradeOfferProperties" class="trade-properties"></div>
                    </div>
                </div>

                <!-- ä¸­é—´ï¼šäº¤æ˜“å¯¹è±¡ -->
                <div class="trade-center">
                    <div style="font-size: 2em;">â¡ï¸</div>
                    <select id="tradeTarget" class="trade-select">
                        <option value="">é€‰æ‹©äº¤æ˜“å¯¹è±¡</option>
                    </select>
                </div>

                <!-- å³ä¾§ï¼šè¯·æ±‚ -->
                <div class="trade-side">
                    <h3>ä½ çš„è¯·æ±‚</h3>
                    <div class="trade-section">
                        <label>ğŸ’° é‡‘é¢:</label>
                        <input type="number" id="tradeRequestMoney" min="0" max="1500" value="0" class="trade-input">
                    </div>
                    <div class="trade-section">
                        <label>ğŸ  åœ°äº§:</label>
                        <div id="tradeRequestProperties" class="trade-properties"></div>
                    </div>
                </div>
            </div>
            <div class="trade-buttons">
                <button class="modal-btn btn-cancel" onclick="closeTradeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="submitTradeOffer()">å‘èµ·äº¤æ˜“</button>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“ç¡®è®¤å¼¹çª— -->
    <div class="modal" id="tradeConfirmModal">
        <div class="modal-content trade-confirm-modal">
            <h2>ğŸ“¨ æ”¶åˆ°äº¤æ˜“è¯·æ±‚</h2>
            <div id="tradeOfferDetails" class="trade-details"></div>
            <div class="trade-buttons">
                <button class="modal-btn btn-cancel" onclick="rejectTrade()">æ‹’ç»</button>
                <button class="modal-btn btn-confirm" onclick="acceptTrade()">æ¥å—äº¤æ˜“</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const BOARD_SIZE = 20;
        const START_MONEY = 1500;

        // æ ¼å­ç±»å‹
        const CELL_TYPES = {
            START: 'start',
            PROPERTY: 'property',
            CHANCE: 'chance',
            CHEST: 'chest',
            TAX: 'tax',
            JAIL: 'jail',
            GO_JAIL: 'go_jail'
        };

        // æ ¼å­æ•°æ® - ä½¿ç”¨æ›´ç²¾ç¾çš„emoji
        // åœ°äº§å¢åŠ  houseCost(å»ºæˆ¿è´¹ç”¨) å’Œ houseRents(å„çº§æˆ¿å±‹ç§Ÿé‡‘)
        // åˆ†ç»„ç­–ç•¥: 14ä¸ªåœ°äº§åˆ†ä¸º6ç»„ - 2ç»„Ã—3ä¸ª + 4ç»„Ã—2ä¸ª
        const cells = [
            { id: 0, type: CELL_TYPES.START, name: 'èµ·ç‚¹', icon: 'ğŸ', desc: 'ç»è¿‡è·å¾— $200' },
            { id: 1, type: CELL_TYPES.PROPERTY, name: 'æ©¡æœ¨æ£®æ—', group: 1, price: 60, rent: 10, houseCost: 50, houseRents: [30, 90, 160, 250], icon: 'ğŸŒ³', desc: 'èŒ‚å¯†çš„æ©¡æ ‘æ—' },
            { id: 2, type: CELL_TYPES.CHEST, name: 'å®ç®±', icon: 'ğŸ“¦', desc: 'è·å¾—éšæœºå¥–åŠ±' },
            { id: 3, type: CELL_TYPES.PROPERTY, name: 'ç™½æ¡¦æ ‘æ—', group: 1, price: 80, rent: 15, houseCost: 50, houseRents: [45, 120, 200, 300], icon: 'ğŸŒ²', desc: 'æ´ç™½çš„æ¡¦æœ¨æ—' },
            { id: 4, type: CELL_TYPES.PROPERTY, name: 'äº‘æ‰æ ‘æ—', group: 1, price: 100, rent: 20, houseCost: 50, houseRents: [60, 150, 250, 400], icon: 'ğŸ„', desc: 'å¯’å†·çš„é’ˆå¶æ—' },
            { id: 5, type: CELL_TYPES.TAX, name: 'æ‰€å¾—ç¨', amount: 200, icon: 'ğŸ’¸', desc: 'ç¼´çº³ç¨æ¬¾ $200' },
            { id: 6, type: CELL_TYPES.PROPERTY, name: 'åºŸå¼ƒçŸ¿äº•', group: 2, price: 120, rent: 25, houseCost: 50, houseRents: [75, 180, 300, 450], icon: 'â›ï¸', desc: 'æ—§çŸ¿äº•é—å€' },
            { id: 7, type: CELL_TYPES.CHANCE, name: 'æœºä¼š', icon: 'â“', desc: 'éšæœºäº‹ä»¶' },
            { id: 8, type: CELL_TYPES.JAIL, name: 'ç›‘ç‹±', icon: 'â›“ï¸', desc: 'åœç•™ä¸€å›åˆ' },
            { id: 9, type: CELL_TYPES.PROPERTY, name: 'æ²™æ¼ ç¥æ®¿', group: 3, price: 140, rent: 30, houseCost: 100, houseRents: [90, 220, 360, 550], icon: 'ğŸœï¸', desc: 'ç¥ç§˜çš„æ²™æ¼ é—è¿¹' },
            { id: 10, type: CELL_TYPES.PROPERTY, name: 'ä¸›æ—ç¥åº™', group: 3, price: 160, rent: 35, houseCost: 100, houseRents: [105, 250, 420, 600], icon: 'ğŸŒ´', desc: 'ä¸›æ—ä¸­çš„å®è—' },
            { id: 11, type: CELL_TYPES.PROPERTY, name: 'æ²¼æ³½å°å±‹', group: 3, price: 180, rent: 40, houseCost: 100, houseRents: [120, 300, 500, 700], icon: 'ğŸ›–', desc: 'å¥³å·«çš„ä½æ‰€' },
            { id: 12, type: CELL_TYPES.CHEST, name: 'å®ç®±', icon: 'ğŸ', desc: 'è·å¾—éšæœºå¥–åŠ±' },
            { id: 13, type: CELL_TYPES.PROPERTY, name: 'æµ·åº•ç¥æ®¿', group: 4, price: 200, rent: 45, houseCost: 100, houseRents: [135, 330, 550, 750], icon: 'ğŸŒŠ', desc: 'æ·±æµ·ä¸­çš„å®«æ®¿' },
            { id: 14, type: CELL_TYPES.PROPERTY, name: 'ä¸‹ç•Œè¦å¡', group: 4, price: 220, rent: 50, houseCost: 150, houseRents: [150, 380, 620, 850], icon: 'ğŸ”¥', desc: 'å±é™©çš„åœ°ç‹±å ¡å’' },
            { id: 15, type: CELL_TYPES.GO_JAIL, name: 'å…¥ç‹±', icon: 'ğŸš”', desc: 'ç›´æ¥é€å…¥ç›‘ç‹±' },
            { id: 16, type: CELL_TYPES.PROPERTY, name: 'æœ«åœ°åŸ', group: 5, price: 240, rent: 55, houseCost: 150, houseRents: [165, 410, 670, 900], icon: 'ğŸ°', desc: 'æµ®ç©ºå²›å±¿åŸå ¡' },
            { id: 17, type: CELL_TYPES.PROPERTY, name: 'æœ«åœ°èˆ¹', group: 5, price: 260, rent: 60, houseCost: 150, houseRents: [180, 440, 720, 950], icon: 'ğŸš¢', desc: 'ç¥ç§˜çš„é£è‰‡' },
            { id: 18, type: CELL_TYPES.CHANCE, name: 'æœºä¼š', icon: 'ğŸ²', desc: 'éšæœºäº‹ä»¶' },
            { id: 19, type: CELL_TYPES.PROPERTY, name: 'æ—åœ°åºœé‚¸', group: 6, price: 300, rent: 70, houseCost: 200, houseRents: [200, 500, 800, 1100], icon: 'ğŸšï¸', desc: 'æœ€çè´µçš„åœ°äº§' }
        ];

        // æœºä¼šå¡
        const chanceCards = [
            { text: 'åœ¨çŸ¿æ´é‡Œå‘ç°é’»çŸ³ï¼è·å¾— $100', effect: 'money', value: 100, icon: 'ğŸ’' },
            { text: 'è¢«è‹¦åŠ›æ€•ç‚¸ä¼¤ï¼æ”¯ä»˜åŒ»ç–—è´¹ $50', effect: 'money', value: -50, icon: 'ğŸ’¥' },
            { text: 'ä¸æ‘æ°‘äº¤æ˜“è·åˆ©ï¼è·å¾— $75', effect: 'money', value: 75, icon: 'ğŸ§‘â€ğŸŒ¾' },
            { text: 'æ‰è¿›å²©æµ†ï¼ä¸¢å¤± $100', effect: 'money', value: -100, icon: 'ğŸ”¥' },
            { text: 'å‘ç°åºŸå¼ƒä¼ é€é—¨ï¼ç›´æ¥å‰è¿›3æ ¼', effect: 'move', value: 3, icon: 'ğŸŒ€' },
            { text: 'è¢«åƒµå°¸è¿½èµ¶ï¼åé€€2æ ¼', effect: 'move', value: -2, icon: 'ğŸ§Ÿ' },
            { text: 'èµ¢å¾—é’“é±¼æ¯”èµ›ï¼è·å¾— $50', effect: 'money', value: 50, icon: 'ğŸ£' },
            { text: 'é­é‡æ å¤ºè€…ï¼æ”¯ä»˜ $80', effect: 'money', value: -80, icon: 'ğŸ¹' }
        ];

        // å®è—å¡
        const chestCards = [
            { text: 'æ‰“å¼€å®ç®±å‘ç°é‡‘è‹¹æœï¼è·å¾— $50', effect: 'money', value: 50, icon: 'ğŸ' },
            { text: 'è·å¾—é™„é­”è£…å¤‡ï¼è·å¾— $100', effect: 'money', value: 100, icon: 'âš”ï¸' },
            { text: 'é“¶è¡Œåˆ©æ¯ï¼è·å¾— $25', effect: 'money', value: 25, icon: 'ğŸ¦' },
            { text: 'å‡ºå”®ç‰©å“ï¼è·å¾— $75', effect: 'money', value: 75, icon: 'ğŸ’' },
            { text: 'ç”Ÿæ—¥å¿«ä¹ï¼è·å¾— $100', effect: 'money', value: 100, icon: 'ğŸ‚' },
            { text: 'ä¿é™©ç†èµ”ï¼è·å¾— $150', effect: 'money', value: 150, icon: 'ğŸ“‹' }
        ];

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            players: [],
            currentPlayer: 0,
            mode: 1,
            dice: [1, 1],
            canBuy: false,
            canBuild: false,
            gameOver: false
        };

        // æˆ¿å±‹æ•°æ®å­˜å‚¨ - æ¯ä¸ªåœ°äº§çš„æˆ¿å±‹ç­‰çº§ (0-4, 4=é…’åº—)
        let houseData = {};

        // åˆå§‹åŒ–æ˜Ÿç©º
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // è·å–æ ¼å­çš„ç»å¯¹ä½ç½®åæ ‡
        // æ£‹ç›˜å¸ƒå±€: 20ä¸ªæ ¼å­å‡åŒ€åˆ†å¸ƒåœ¨å››å‘¨ (5ä¸ª/è¾¹)
        // è§’è½ä½ç½®: index 0(å·¦ä¸‹), 5(å³ä¸‹), 10(å³ä¸Š), 15(å·¦ä¸Š)
        function getCellPosition(index, isSmall = false) {
            const cellSize = isSmall ? 68 : 100;
            const gap = 4;
            const padding = isSmall ? 8 : 10;
            const spacing = cellSize + gap;

            // æ­£ç¡®çš„6x6ç½‘æ ¼å¸ƒå±€ï¼Œå¤–å›´ä¸€åœˆæ”¾ç½®æ ¼å­
            // æ£‹ç›˜å¸ƒå±€: 6x6ç½‘æ ¼ï¼Œå¤–å›´ä¸€åœˆæ”¾ç½®20ä¸ªæ ¼å­
            // åº•è¾¹(row 5): index 0-5 (ä»å·¦åˆ°å³ï¼Œcol 0-5)
            // å³è¾¹(col 5): index 6-9 (ä»ä¸‹åˆ°ä¸Šï¼Œrow 4-1)
            // é¡¶è¾¹(row 0): index 10-15 (ä»å³åˆ°å·¦ï¼Œcol 5-0)
            // å·¦è¾¹(col 0): index 16-19 (ä»ä¸Šåˆ°ä¸‹ï¼Œrow 1-4)

            if (index >= 0 && index <= 5) {
                // åº•è¾¹: ä»å·¦åˆ°å³
                return {
                    left: padding + index * spacing,
                    top: padding + 5 * spacing
                };
            } else if (index >= 6 && index <= 9) {
                // å³è¾¹: ä»ä¸‹åˆ°ä¸Š (ä¸å«è§’è½)
                return {
                    left: padding + 5 * spacing,
                    top: padding + (10 - index) * spacing
                };
            } else if (index >= 10 && index <= 15) {
                // é¡¶è¾¹: ä»å³åˆ°å·¦
                return {
                    left: padding + (15 - index) * spacing,
                    top: padding
                };
            } else {
                // å·¦è¾¹: ä»ä¸Šåˆ°ä¸‹ (ä¸å«è§’è½ï¼Œrow 1-4)
                return {
                    left: padding,
                    top: padding + (index - 15) * spacing
                };
            }
        }

        // åˆ›å»ºæ£‹ç›˜
        function createBoard() {
            const board = document.getElementById('board');
            // ä¿ç•™ä¸­å¿ƒåŒºåŸŸå’Œç©å®¶æ£‹å­
            const center = board.querySelector('.board-center');
            const players = [];
            gameState.players.forEach((_, index) => {
                const p = document.getElementById(`player-${index}`);
                if (p) players.push(p);
            });

            // ç§»é™¤æ—§æ ¼å­ï¼ˆåªç§»é™¤cellç±»å…ƒç´ ï¼‰
            const oldCells = board.querySelectorAll('.cell');
            oldCells.forEach(cell => cell.remove());

            // ç¡®ä¿ä¸­å¿ƒåŒºåŸŸåœ¨DOMä¸­
            if (center && !board.contains(center)) {
                board.appendChild(center);
            }

            // æ£€æµ‹æ˜¯å¦ä½¿ç”¨å°å°ºå¯¸
            const isSmall = window.innerWidth <= 1200;

            // åˆ›å»ºæ ¼å­
            cells.forEach((cell, index) => {
                const cellEl = document.createElement('div');
                cellEl.className = `cell cell-${cell.type}`;
                if (cell.group) {
                    cellEl.className += ` cell-group-${cell.group}`;
                }

                // è§’è½æ ¼å­ (æ–°å¸ƒå±€: 0=èµ·ç‚¹å·¦ä¸‹, 5=ç¨æ”¶å³ä¸‹, 10=å®ç®±å³ä¸Š, 15=å…¥ç‹±å·¦ä¸Š)
                if (index === 0 || index === 5 || index === 10 || index === 15) {
                    cellEl.className += ' cell-corner';
                }

                const pos = getCellPosition(index, isSmall);
                cellEl.style.left = pos.left + 'px';
                cellEl.style.top = pos.top + 'px';
                cellEl.id = `cell-${index}`;

                // æ·»åŠ åˆ†ç»„æ ‡è¯†
                const groupBadge = cell.group ? `<span class="group-badge">${cell.group}ç»„</span>` : '';

                cellEl.innerHTML = `
                    ${groupBadge}
                    <div class="cell-icon">${cell.icon}</div>
                    <div class="cell-name">${cell.name}</div>
                    ${cell.price ? `<div class="cell-price">$${cell.price}</div>` : ''}
                `;

                // æ·»åŠ æ‰€æœ‰æƒæ ‡è®°å’Œæˆ¿å±‹æ ‡è®°
                const owner = getOwner(cell.id);
                if (owner) {
                    const mark = document.createElement('div');
                    mark.className = 'owner-mark';
                    mark.style.background = owner.color;
                    cellEl.appendChild(mark);

                    // æ˜¾ç¤ºæˆ¿å±‹
                    const houseLevel = houseData[cell.id] || 0;
                    if (houseLevel > 0) {
                        const houseContainer = document.createElement('div');
                        houseContainer.className = 'house-markers';

                        if (houseLevel === 5) {
                            // é…’åº—
                            const hotel = document.createElement('div');
                            hotel.className = 'house-hotel';
                            hotel.textContent = 'H';
                            houseContainer.appendChild(hotel);
                        } else {
                            // æ™®é€šæˆ¿å±‹
                            for (let i = 0; i < houseLevel; i++) {
                                const house = document.createElement('div');
                                house.className = 'house-marker';
                                houseContainer.appendChild(house);
                            }
                        }
                        cellEl.appendChild(houseContainer);
                    }
                }

                // æ‚¬æµ®æç¤º
                cellEl.addEventListener('mouseenter', (e) => showTooltip(e, cell));
                cellEl.addEventListener('mouseleave', hideTooltip);

                board.appendChild(cellEl);
            });

            // é‡æ–°æ·»åŠ ç©å®¶æ£‹å­ï¼ˆå¦‚æœä¸åœ¨DOMä¸­ï¼‰
            players.forEach(p => {
                if (!board.contains(p)) {
                    board.appendChild(p);
                }
            });

            // é‡æ–°å®šä½ç©å®¶
            gameState.players.forEach((player, index) => {
                let playerEl = document.getElementById(`player-${index}`);
                if (!playerEl) {
                    // å¦‚æœç©å®¶å…ƒç´ ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
                    playerEl = document.createElement('div');
                    playerEl.className = `player ${player.class}`;
                    playerEl.id = `player-${index}`;
                    // æ ¹æ®ç©å®¶ç´¢å¼•æ˜¾ç¤ºä¸åŒæ ‡ç­¾
                    if (player.isAI) {
                        playerEl.textContent = 'AI';
                    } else {
                        playerEl.textContent = `P${index + 1}`;
                    }
                    board.appendChild(playerEl);
                }
                // æ›´æ–°ä½ç½®
                updatePlayerPosition(index);
            });
        }

        // æ˜¾ç¤ºæ‚¬æµ®æç¤º
        function showTooltip(e, cell) {
            const tooltip = document.getElementById('tooltip');
            let content = `<div class="tooltip-title">${cell.icon} ${cell.name}</div>`;
            content += `<div class="tooltip-info">${cell.desc}</div>`;

            if (cell.type === CELL_TYPES.PROPERTY) {
                const owner = getOwner(cell.id);
                const houseLevel = houseData[cell.id] || 0;

                // åˆ†ç»„ä¿¡æ¯
                const groupNames = ['', 'ğŸŸ« æ£•è‰²ç»„(3ä¸ª)', 'ğŸ”µ è“è‰²ç»„(2ä¸ª)', 'ğŸŸ£ ç´«è‰²ç»„(3ä¸ª)', 'ğŸŸ  æ©™è‰²ç»„(2ä¸ª)', 'ğŸŸ¡ é»„è‰²ç»„(2ä¸ª)', 'ğŸŸ¢ ç»¿è‰²ç»„(2ä¸ª)'];
                const groupColors = ['', '#8D6E63', '#42A5F5', '#AB47BC', '#FF7043', '#FBC02D', '#66BB6A'];
                content += `<div style="margin-top:6px;color:${groupColors[cell.group]};font-weight:bold">æ‰€å±åˆ†ç»„: ${groupNames[cell.group]}</div>`;

                // æ˜¾ç¤ºåŒç»„å…¶ä»–åœ°äº§
                const groupProps = cells.filter(c => c.group === cell.group);
                content += `<div style="margin-top:4px;font-size:10px;color:#888">`;
                content += `åŒç»„åœ°äº§: ${groupProps.map(p => p.name).join('ã€')}`;
                content += `</div>`;

                content += `<div style="margin-top:8px;color:#4CAF50">åŸºç¡€ç§Ÿé‡‘: $${cell.rent}</div>`;
                content += `<div style="color:#FF9800">å»ºæˆ¿è´¹ç”¨: $${cell.houseCost}</div>`;

                // æ˜¾ç¤ºå„çº§ç§Ÿé‡‘
                content += `<div style="margin-top:4px;font-size:11px;color:#aaa">`;
                content += `1ğŸ :$${cell.houseRents[0]} 2ğŸ :$${cell.houseRents[1]}<br>`;
                content += `3ğŸ :$${cell.houseRents[2]} 4ğŸ :$${cell.houseRents[3]}`;
                content += `</div>`;

                // å»ºæˆ¿æ¡ä»¶æ£€æŸ¥
                if (owner) {
                    content += `<div style="margin-top:8px;color:#FFD700">æ‰€æœ‰è€…: ${owner.name}</div>`;
                    if (houseLevel > 0) {
                        const houseText = houseLevel === 5 ? 'ğŸ¨ é…’åº—' : 'ğŸ '.repeat(houseLevel);
                        content += `<div style="color:#FF6B6B">å½“å‰ç­‰çº§: ${houseText}</div>`;
                    }
                    content += `<div style="color:#00BCD4;font-weight:bold">å½“å‰ç§Ÿé‡‘: $${calculateRent(cell, owner)}</div>`;

                    // æ˜¾ç¤ºå»ºæˆ¿æ¡ä»¶
                    const ownedInGroup = groupProps.filter(p => owner.properties.includes(p.id));
                    if (ownedInGroup.length === groupProps.length) {
                        if (houseLevel < 5) {
                            content += `<div style="margin-top:6px;color:#4CAF50;font-weight:bold">âœ… å¯å»ºé€ æˆ¿å±‹!</div>`;
                        } else {
                            content += `<div style="margin-top:6px;color:#9E9E9E">å·²è¾¾åˆ°æœ€é«˜ç­‰çº§</div>`;
                        }
                    } else {
                        content += `<div style="margin-top:6px;color:#FF5722">âš ï¸ éœ€é›†é½åŒç»„${groupProps.length}ä¸ªåœ°äº§æ‰èƒ½å»ºæˆ¿<br>(å·²æ‹¥æœ‰ ${ownedInGroup.length}/${groupProps.length})</div>`;
                    }
                }
            } else if (cell.type === CELL_TYPES.TAX) {
                content += `<div style="margin-top:8px;color:#ff6b6b">ç¨è´¹: $${cell.amount}</div>`;
            }

            tooltip.innerHTML = content;
            tooltip.style.display = 'block';
            tooltip.style.left = e.clientX + 15 + 'px';
            tooltip.style.top = e.clientY + 15 + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame(mode) {
            gameState.mode = mode;

            // ç©å®¶é…ç½®ï¼šé¢œè‰²å’ŒCSSç±»
            const playerConfigs = [
                { color: '#ff4444', class: 'p1', name: 'ç©å®¶1' },
                { color: '#4444ff', class: 'p2', name: 'ç©å®¶2' },
                { color: '#9c27b0', class: 'p3', name: 'ç©å®¶3' },
                { color: '#ff5722', class: 'p4', name: 'ç©å®¶4' },
                { color: '#00bcd4', class: 'p5', name: 'ç©å®¶5' },
                { color: '#8bc34a', class: 'p6', name: 'ç©å®¶6' }
            ];

            gameState.players = [];

            if (mode === 1) {
                // å•äººæ¨¡å¼ï¼šç©å®¶1 + AI
                gameState.players.push({
                    id: 0, name: 'ç©å®¶1', money: START_MONEY, position: 0, properties: [],
                    inJail: false, jailTurns: 0, color: playerConfigs[0].color, class: playerConfigs[0].class
                });
                gameState.players.push({
                    id: 1, name: 'AIç©å®¶', money: START_MONEY, position: 0, properties: [],
                    inJail: false, jailTurns: 0, color: '#ff8800', class: 'ai', isAI: true
                });
            } else {
                // å¤šäººæ¨¡å¼ï¼š2-6äºº
                for (let i = 0; i < mode; i++) {
                    gameState.players.push({
                        id: i, name: playerConfigs[i].name, money: START_MONEY, position: 0, properties: [],
                        inJail: false, jailTurns: 0, color: playerConfigs[i].color, class: playerConfigs[i].class
                    });
                }
            }

            gameState.currentPlayer = 0;
            gameState.gameOver = false;

            // åˆå§‹åŒ–æˆ¿å±‹æ•°æ®
            houseData = {};
            for (let i = 0; i < BOARD_SIZE; i++) {
                houseData[i] = 0;
            }

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameArea').style.display = 'grid';

            createBoard();
            createPlayers();
            updatePlayerInfo();
            addLog('æ¸¸æˆå¼€å§‹ï¼ç©å®¶1å…ˆæ·éª°å­', 'system');
        }

        // åˆ›å»ºç©å®¶æ£‹å­
        function createPlayers() {
            // å…ˆæ¸…é™¤æ‰€æœ‰ç°æœ‰ç©å®¶æ£‹å­ï¼Œé˜²æ­¢é‡å¤
            document.querySelectorAll('.player').forEach(el => el.remove());

            gameState.players.forEach((player, index) => {
                const playerEl = document.createElement('div');
                playerEl.className = `player ${player.class}`;
                playerEl.id = `player-${index}`;
                // æ ¹æ®ç©å®¶ç±»å‹æ˜¾ç¤ºä¸åŒæ ‡ç­¾
                if (player.isAI) {
                    playerEl.textContent = 'AI';
                } else {
                    playerEl.textContent = `P${index + 1}`;
                }
                document.getElementById('board').appendChild(playerEl);
                updatePlayerPosition(index);
            });
        }

        // æ›´æ–°ç©å®¶ä½ç½®
        function updatePlayerPosition(playerIndex) {
            const player = gameState.players[playerIndex];
            const cellEl = document.getElementById(`cell-${player.position}`);
            const playerEl = document.getElementById(`player-${playerIndex}`);

            if (!cellEl || !playerEl) {
                console.log(`æ— æ³•æ›´æ–°ç©å®¶${playerIndex}ä½ç½®: cell=${!!cellEl}, player=${!!playerEl}`);
                return;
            }

            // æ£€æµ‹æ˜¯å¦ä½¿ç”¨å°å°ºå¯¸
            const isSmall = window.innerWidth <= 1200;
            const playerSize = isSmall ? 28 : 36;

            // è®¡ç®—ç›¸å¯¹ä½ç½®
            const cellLeft = parseInt(cellEl.style.left) || 0;
            const cellTop = parseInt(cellEl.style.top) || 0;
            const cellWidth = cellEl.offsetWidth || 100;
            const cellHeight = cellEl.offsetHeight || 100;

            // æ£‹å­åœ¨æ ¼å­ä¸­çš„ä½ç½® - æ ¹æ®ç©å®¶ç´¢å¼•å¯¼åˆ†é…ä¸åŒè§’è½ï¼Œé¿å…é‡å 
            // å°†æ ¼å­åˆ†æˆ2x2ç½‘æ ¼ï¼Œæœ€å¤šå®¹çº³4ä¸ªç©å®¶
            // æ‰©å±•åˆ°æ”¯æŒ6ä¸ªç©å®¶ï¼šä½¿ç”¨åç§»é‡åŒºåˆ†
            let offsetX, offsetY;

            if (playerIndex === 0) {
                // P1: å·¦ä¸Š
                offsetX = 4;
                offsetY = 4;
            } else if (playerIndex === 1) {
                // P2/AI: å³ä¸‹
                offsetX = cellWidth - playerSize - 4;
                offsetY = cellHeight - playerSize - 4;
            } else if (playerIndex === 2) {
                // P3: å³ä¸Š
                offsetX = cellWidth - playerSize - 4;
                offsetY = 4;
            } else if (playerIndex === 3) {
                // P4: å·¦ä¸‹
                offsetX = 4;
                offsetY = cellHeight - playerSize - 4;
            } else if (playerIndex === 4) {
                // P5: ä¸­é—´åå·¦ä¸Š
                offsetX = cellWidth / 2 - playerSize / 2 - 2;
                offsetY = cellHeight / 2 - playerSize / 2 - 2;
            } else {
                // P6: ä¸­é—´åå³ä¸‹
                offsetX = cellWidth / 2 - playerSize / 2 + 2;
                offsetY = cellHeight / 2 - playerSize / 2 + 2;
            }

            playerEl.style.left = (cellLeft + offsetX) + 'px';
            playerEl.style.top = (cellTop + offsetY) + 'px';
        }

        // æ›´æ–°ç©å®¶ä¿¡æ¯é¢æ¿
        function updatePlayerInfo() {
            const container = document.getElementById('playerInfos');
            container.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const infoEl = document.createElement('div');
                infoEl.className = `player-info ${player.class} ${index === gameState.currentPlayer ? 'active' : ''}`;

                // æŒ‰ç»„æ˜¾ç¤ºåœ°äº§
                const propertyByGroup = {};
                const groupColors = ['', '#8D6E63', '#42A5F5', '#AB47BC', '#FF7043', '#FBC02D', '#66BB6A'];
                const groupBadges = ['', 'ğŸŸ«', 'ğŸ”µ', 'ğŸŸ£', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢'];

                player.properties.forEach(p => {
                    const cell = cells[p];
                    if (cell.group) {
                        if (!propertyByGroup[cell.group]) propertyByGroup[cell.group] = [];
                        propertyByGroup[cell.group].push(cell);
                    }
                });

                let propsHTML = '';
                for (let g = 1; g <= 6; g++) {
                    if (propertyByGroup[g] && propertyByGroup[g].length > 0) {
                        const groupSize = cells.filter(c => c.group === g).length;
                        const isComplete = propertyByGroup[g].length === groupSize;
                        const statusIcon = isComplete ? 'âœ…' : groupBadges[g];
                        const bgColor = isComplete ? groupColors[g] : 'transparent';
                        const textColor = isComplete ? '#fff' : '#ccc';

                        propsHTML += `<div style="margin:4px 0;padding:4px 8px;border-radius:6px;background:${isComplete ? groupColors[g] + '40' : 'rgba(255,255,255,0.05)'};border:1px solid ${isComplete ? groupColors[g] : 'transparent'};">`;
                        propsHTML += `<span style="color:${isComplete ? groupColors[g] : '#888'};font-weight:bold;">${statusIcon} ${g}ç»„ (${propertyByGroup[g].length}/${groupSize})</span>`;
                        propsHTML += `<div style="margin-top:2px;">`;
                        propertyByGroup[g].forEach(cell => {
                            const houseLevel = houseData[cell.id] || 0;
                            const houseIcon = houseLevel === 5 ? 'ğŸ¨' : (houseLevel > 0 ? 'ğŸ '.repeat(houseLevel) : '');
                            propsHTML += `<span class="property-tag" style="background:${groupColors[g]}40;border:1px solid ${groupColors[g]};">${cell.icon} ${cell.name} ${houseIcon}</span>`;
                        });
                        propsHTML += `</div></div>`;
                    }
                }

                if (propsHTML === '') {
                    propsHTML = '<span style="color:#888">æ— åœ°äº§</span>';
                }

                // ç»Ÿè®¡å®Œæ•´ç»„æ•°
                let completeGroups = 0;
                for (let g = 1; g <= 6; g++) {
                    const groupProps = cells.filter(c => c.group === g);
                    const ownedInGroup = player.properties.filter(p => {
                        const cell = cells[p];
                        return cell.group === g;
                    }).length;
                    if (ownedInGroup === groupProps.length && groupProps.length > 0) {
                        completeGroups++;
                    }
                }

                const currentCell = cells[player.position];

                infoEl.innerHTML = `
                    <div class="player-name">
                        <span class="player-badge" style="background:${player.color}"></span>
                        ${player.name} ${player.inJail ? 'ğŸ”’' : ''}
                        ${index === gameState.currentPlayer ? '<span style="font-size:0.7em;background:#FFD700;color:#333;padding:2px 8px;border-radius:10px;margin-left:8px;">å½“å‰</span>' : ''}
                    </div>
                    <div class="player-money">ğŸ’° $${player.money}</div>
                    <div style="font-size:0.85em;color:#aaa;margin:4px 0;">é›†é½é¢œè‰²ç»„: ${completeGroups}/6 ${completeGroups > 0 ? 'ğŸ”¥' : ''}</div>
                    <div class="player-position">ğŸ“ ä½ç½®: ${currentCell.icon} ${currentCell.name}</div>
                    <div class="player-properties">${propsHTML}</div>
                `;

                container.appendChild(infoEl);
            });
        }

        // æ·éª°å­
        async function rollDice() {
            if (gameState.gameOver) return;

            const player = gameState.players[gameState.currentPlayer];

            if (player.inJail) {
                handleJail();
                return;
            }

            document.getElementById('rollBtn').disabled = true;

            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');

            dice1.classList.add('rolling');
            dice2.classList.add('rolling');

            await sleep(600);

            gameState.dice[0] = Math.floor(Math.random() * 6) + 1;
            gameState.dice[1] = Math.floor(Math.random() * 6) + 1;

            dice1.classList.remove('rolling');
            dice2.classList.remove('rolling');

            dice1.textContent = getDiceIcon(gameState.dice[0]);
            dice2.textContent = getDiceIcon(gameState.dice[1]);

            const total = gameState.dice[0] + gameState.dice[1];
            addLog(`${player.name} æ·å‡ºäº† ${total} ç‚¹ (${gameState.dice[0]}+${gameState.dice[1]})`, player.class);

            await movePlayer(gameState.currentPlayer, total);
            await handleCellEvent(gameState.currentPlayer);

            updatePlayerInfo();

            if (!gameState.gameOver) {
                document.getElementById('endBtn').disabled = false;

                // å¯ç”¨äº¤æ˜“æŒ‰é’®ï¼ˆå½“æ¸¸æˆæœ‰å¤šäºä¸€ä¸ªç©å®¶æ—¶ï¼‰
                if (gameState.players.length > 1 && !player.isAI) {
                    document.getElementById('tradeBtn').disabled = false;
                }

                if (player.isAI) {
                    await sleep(1200);
                    await aiTurn();
                }
            }
        }

        function getDiceIcon(num) {
            const icons = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
            return icons[num - 1];
        }

        // ç§»åŠ¨ç©å®¶
        async function movePlayer(playerIndex, steps) {
            const player = gameState.players[playerIndex];
            addLog(`${player.name} å¼€å§‹ç§»åŠ¨ ${steps} æ­¥...`, 'system');

            for (let i = 0; i < steps; i++) {
                // å‰è¿›ä¸€æ­¥
                player.position = (player.position + 1) % BOARD_SIZE;
                updatePlayerPosition(playerIndex);

                // ç»è¿‡èµ·ç‚¹æ£€æµ‹ï¼ˆåªæœ‰çœŸæ­£ç»è¿‡æ—¶æ‰ç»™é’±ï¼Œä¸æ˜¯è½åœ¨èµ·ç‚¹ï¼‰
                if (player.position === 0) {
                    player.money += 200;
                    addLog(`${player.name} ç»è¿‡èµ·ç‚¹ï¼Œè·å¾— $200`, 'event');
                    createParticles(document.getElementById(`player-${playerIndex}`));
                }

                // æ¯æ­¥ç§»åŠ¨é—´éš” 400msï¼Œè®©ç§»åŠ¨æ›´æ¸…æ™°
                await sleep(400);
            }

            addLog(`${player.name} åˆ°è¾¾ ${cells[player.position].name}`, player.class);
        }

        // å¤„ç†æ ¼å­äº‹ä»¶
        async function handleCellEvent(playerIndex) {
            const player = gameState.players[playerIndex];
            const cell = cells[player.position];

            switch (cell.type) {
                case CELL_TYPES.START:
                    player.money += 200;
                    addLog(`${player.name} åˆ°è¾¾èµ·ç‚¹ï¼Œè·å¾— $200`, 'event');
                    showModal('èµ·ç‚¹', 'ğŸ', `${player.name} åˆ°è¾¾èµ·ç‚¹ï¼Œè·å¾— $200ï¼`, 'win');
                    break;

                case CELL_TYPES.PROPERTY:
                    const owner = getOwner(cell.id);
                    if (!owner) {
                        if (player.money >= cell.price) {
                            gameState.canBuy = true;
                            document.getElementById('buyBtn').disabled = false;
                            addLog(`${cell.name} å¯è´­ä¹°ï¼Œä»·æ ¼ $${cell.price}`, 'system');
                        } else {
                            addLog(`${player.name} èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•è´­ä¹° ${cell.name}`, player.class);
                        }
                    } else if (owner.id !== player.id) {
                        const rent = calculateRent(cell, owner);
                        player.money -= rent;
                        owner.money += rent;
                        addLog(`${player.name} æ”¯ä»˜ç§Ÿé‡‘ $${rent} ç»™ ${owner.name}`, player.class);

                        if (player.money < 0) {
                            handleBankruptcy(playerIndex);
                        }
                    } else {
                        addLog(`${player.name} å›åˆ°äº†è‡ªå·±çš„ ${cell.name}`, player.class);
                        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å»ºé€ æˆ¿å±‹
                        const currentLevel = houseData[cell.id] || 0;
                        const groupProps = cells.filter(c => c.group === cell.group);
                        const ownedInGroup = groupProps.filter(c => player.properties.includes(c.id));
                        const groupNames = ['', 'æ£•è‰²ç»„', 'è“è‰²ç»„', 'ç´«è‰²ç»„', 'æ©™è‰²ç»„', 'é»„è‰²ç»„', 'ç»¿è‰²ç»„'];

                        if (currentLevel < 5 && ownedInGroup.length === groupProps.length) {
                            if (player.money >= cell.houseCost) {
                                gameState.canBuild = true;
                                document.getElementById('buildBtn').disabled = false;
                                const levelNames = ['', '1çº§', '2çº§', '3çº§', '4çº§', 'é…’åº—'];
                                addLog(`âœ… é›†é½${groupNames[cell.group]}ï¼å¯å»ºé€ ç¬¬${levelNames[currentLevel + 1]} ($${cell.houseCost})`, 'event');
                            } else {
                                addLog(`${cell.name} å¯ä»¥å»ºé€ æˆ¿å±‹ï¼Œä½†èµ„é‡‘ä¸è¶³ ($${cell.houseCost})`, 'system');
                            }
                        } else if (currentLevel >= 5) {
                            addLog(`${cell.name} å·²è¾¾åˆ°æœ€é«˜ç­‰çº§(é…’åº—)`, 'system');
                        } else if (ownedInGroup.length !== groupProps.length) {
                            const need = groupProps.length - ownedInGroup.length;
                            const missing = groupProps.filter(c => !player.properties.includes(c.id)).map(c => c.name).join('ã€');
                            addLog(`âš ï¸ é›†é½${groupNames[cell.group]}è¿˜éœ€${need}ä¸ª: ${missing}`, player.class);
                        }
                    }
                    break;

                case CELL_TYPES.CHANCE:
                    await drawCard('chance');
                    break;

                case CELL_TYPES.CHEST:
                    await drawCard('chest');
                    break;

                case CELL_TYPES.TAX:
                    player.money -= cell.amount;
                    addLog(`${player.name} ç¼´çº³ç¨æ¬¾ $${cell.amount}`, player.class);
                    showModal('ç¨æ”¶', 'ğŸ’¸', `${player.name} éœ€è¦ç¼´çº³ç¨æ¬¾ $${cell.amount}ï¼`, 'tax');
                    if (player.money < 0) {
                        handleBankruptcy(playerIndex);
                    }
                    break;

                case CELL_TYPES.JAIL:
                    addLog(`${player.name} åªæ˜¯å‚è§‚ç›‘ç‹±`, player.class);
                    break;

                case CELL_TYPES.GO_JAIL:
                    player.inJail = true;
                    player.jailTurns = 3;
                    player.position = 8;
                    updatePlayerPosition(playerIndex);
                    addLog(`${player.name} è¢«æ•å…¥ç‹±ï¼`, player.class);
                    showModal('å…¥ç‹±', 'â›“ï¸', `${player.name} è¢«æ•å…¥ç‹±ï¼åœç•™3å›åˆæˆ–æ”¯ä»˜ $50 ä¿é‡Šã€‚`, 'jail');
                    break;
            }
        }

        function getOwner(cellId) {
            return gameState.players.find(p => p.properties.includes(cellId));
        }

        function calculateRent(cell, owner) {
            const houseLevel = houseData[cell.id] || 0;

            // å¦‚æœæœ‰æˆ¿å±‹ï¼ŒæŒ‰æˆ¿å±‹ç­‰çº§è®¡ç®—ç§Ÿé‡‘
            if (houseLevel > 0) {
                if (houseLevel === 5) {
                    // é…’åº— (ç¬¬5çº§)
                    return cell.houseRents[3] * 2;
                }
                return cell.houseRents[houseLevel - 1];
            }

            // æ²¡æœ‰æˆ¿å±‹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´é¢œè‰²ç»„
            let rent = cell.rent;
            const groupProps = cells.filter(c => c.group === cell.group);
            const ownedInGroup = groupProps.filter(c => owner.properties.includes(c.id));

            if (ownedInGroup.length === groupProps.length) {
                rent *= 2;
            }

            return rent;
        }

        async function drawCard(type) {
            const cards = type === 'chance' ? chanceCards : chestCards;
            const card = cards[Math.floor(Math.random() * cards.length)];
            const player = gameState.players[gameState.currentPlayer];

            showModal(
                type === 'chance' ? 'â“ æœºä¼š' : 'ğŸ“¦ å®ç®±',
                card.icon,
                card.text,
                type === 'chance' ? 'chance' : 'chest'
            );

            await sleep(600);

            if (card.effect === 'money') {
                player.money += card.value;
                if (card.value > 0) {
                    addLog(`${player.name} è·å¾— $${card.value}`, 'event');
                    createParticles(document.getElementById(`player-${gameState.currentPlayer}`));
                } else {
                    addLog(`${player.name} å¤±å» $${Math.abs(card.value)}`, player.class);
                }

                if (player.money < 0) {
                    handleBankruptcy(gameState.currentPlayer);
                }
            } else if (card.effect === 'move') {
                await movePlayer(gameState.currentPlayer, card.value);
                await handleCellEvent(gameState.currentPlayer);
            }
        }

        function buyProperty() {
            if (!gameState.canBuy) return;

            const player = gameState.players[gameState.currentPlayer];
            const cell = cells[player.position];

            player.money -= cell.price;
            player.properties.push(cell.id);
            gameState.canBuy = false;

            const cellEl = document.getElementById(`cell-${player.position}`);
            const mark = document.createElement('div');
            mark.className = 'owner-mark';
            mark.style.background = player.color;
            cellEl.appendChild(mark);

            addLog(`${player.name} è´­ä¹°äº† ${cell.name}ï¼`, player.class);
            document.getElementById('buyBtn').disabled = true;
            updatePlayerInfo();
        }

        function handleJail() {
            const player = gameState.players[gameState.currentPlayer];

            if (player.isAI) {
                if (player.money >= 50) {
                    player.money -= 50;
                    player.inJail = false;
                    player.jailTurns = 0;
                    addLog(`${player.name} æ”¯ä»˜ä¿é‡Šé‡‘å‡ºç‹±`, player.class);
                    rollDice();
                } else {
                    player.jailTurns--;
                    if (player.jailTurns <= 0) {
                        player.inJail = false;
                        addLog(`${player.name} åˆ‘æ»¡é‡Šæ”¾`, player.class);
                    } else {
                        addLog(`${player.name} åœ¨ç›‘ç‹±ä¸­ï¼Œè¿˜å‰© ${player.jailTurns} å›åˆ`, player.class);
                        endTurn();
                    }
                }
            } else {
                if (confirm('ä½ åœ¨ç›‘ç‹±ä¸­ï¼æ”¯ä»˜ $50 ä¿é‡Šé‡‘ç«‹å³å‡ºç‹±å—ï¼Ÿ\n\nï¼ˆå–æ¶ˆåˆ™åœç•™ä¸€å›åˆï¼Œå‰©ä½™' + player.jailTurns + 'å›åˆï¼‰')) {
                    if (player.money >= 50) {
                        player.money -= 50;
                        player.inJail = false;
                        player.jailTurns = 0;
                        addLog(`${player.name} æ”¯ä»˜ä¿é‡Šé‡‘å‡ºç‹±`, player.class);
                        document.getElementById('rollBtn').disabled = false;
                    } else {
                        alert('èµ„é‡‘ä¸è¶³ï¼');
                        player.jailTurns--;
                        if (player.jailTurns <= 0) {
                            player.inJail = false;
                        }
                        endTurn();
                    }
                } else {
                    player.jailTurns--;
                    if (player.jailTurns <= 0) {
                        player.inJail = false;
                        addLog(`${player.name} åˆ‘æ»¡é‡Šæ”¾`, player.class);
                    } else {
                        addLog(`${player.name} åœ¨ç›‘ç‹±ä¸­ï¼Œè¿˜å‰© ${player.jailTurns} å›åˆ`, player.class);
                    }
                    endTurn();
                }
            }
            updatePlayerInfo();
        }

        // å»ºé€ æˆ¿å±‹ - æ¯å›åˆåªèƒ½å»ºé€ ä¸€æ¬¡
        function buildHouse() {
            if (!gameState.canBuild) return;

            const player = gameState.players[gameState.currentPlayer];
            const cell = cells[player.position];

            // æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰è¯¥åœ°äº§
            if (!player.properties.includes(cell.id)) {
                addLog(`${player.name} ä¸æ‹¥æœ‰è¿™å—åœ°äº§ï¼Œæ— æ³•å»ºé€ `, player.class);
                return;
            }

            const currentLevel = houseData[cell.id] || 0;

            if (currentLevel >= 5) {
                addLog(`${cell.name} å·²ç»è¾¾åˆ°æœ€å¤§ç­‰çº§ï¼ˆé…’åº—ï¼‰`, 'system');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´é¢œè‰²ç»„ï¼ˆæˆ¿å±‹è§„åˆ™ï¼šéœ€è¦æœ‰å®Œæ•´é¢œè‰²ç»„æ‰èƒ½å»ºæˆ¿ï¼‰
            const groupProps = cells.filter(c => c.group === cell.group);
            const ownedInGroup = groupProps.filter(c => player.properties.includes(c.id));

            if (ownedInGroup.length !== groupProps.length) {
                addLog(`éœ€è¦æ‹¥æœ‰å®Œæ•´é¢œè‰²ç»„æ‰èƒ½åœ¨ ${cell.name} å»ºé€ æˆ¿å±‹ï¼`, player.class);
                showModal('æ— æ³•å»ºé€ ', 'ğŸ ', `éœ€è¦æ‹¥æœ‰å®Œæ•´é¢œè‰²ç»„æ‰èƒ½å»ºé€ æˆ¿å±‹ï¼\nè¯·æ”¶é›†åŒä¸€é¢œè‰²çš„æ‰€æœ‰åœ°äº§ã€‚`, 'normal');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦èµ„é‡‘å……è¶³
            if (player.money < cell.houseCost) {
                addLog(`${player.name} èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•å»ºé€ æˆ¿å±‹`, player.class);
                return;
            }

            // å»ºé€ æˆ¿å±‹
            player.money -= cell.houseCost;
            houseData[cell.id] = currentLevel + 1;

            const levelNames = ['', 'ğŸ  1çº§', 'ğŸ ğŸ  2çº§', 'ğŸ ğŸ ğŸ  3çº§', 'ğŸ ğŸ ğŸ ğŸ  4çº§', 'ğŸ¨ é…’åº—'];
            const levelName = levelNames[houseData[cell.id]];

            addLog(`${player.name} åœ¨ ${cell.name} å»ºé€ äº† ${levelName}ï¼`, player.class);

            // é‡æ–°åˆ›å»ºæ£‹ç›˜ä»¥æ˜¾ç¤ºæˆ¿å±‹
            createBoard();

            // æ›´æ–°ç©å®¶ä¿¡æ¯
            updatePlayerInfo();

            // æ¯å›åˆåªèƒ½å»ºé€ ä¸€æ¬¡ï¼Œå»ºé€ åç¦ç”¨æŒ‰é’®
            gameState.canBuild = false;
            document.getElementById('buildBtn').disabled = true;
            addLog(`æœ¬å›åˆå·²å»ºé€ æˆ¿å±‹ï¼Œå¦‚éœ€ç»§ç»­å»ºé€ è¯·ç­‰å¾…ä¸‹ä¸€å›åˆ`, 'system');
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å»ºé€ æˆ¿å±‹
        function checkBuildAvailability() {
            const player = gameState.players[gameState.currentPlayer];
            const cell = cells[player.position];

            if (player.properties.includes(cell.id)) {
                const currentLevel = houseData[cell.id] || 0;
                if (currentLevel < 5) {
                    const groupProps = cells.filter(c => c.group === cell.group);
                    const ownedInGroup = groupProps.filter(c => player.properties.includes(c.id));
                    if (ownedInGroup.length === groupProps.length && player.money >= cell.houseCost) {
                        document.getElementById('buildBtn').disabled = false;
                        return;
                    }
                }
            }
            document.getElementById('buildBtn').disabled = true;
        }

        // ==================== äº¤æ˜“åŠŸèƒ½ ====================

        let pendingTrade = null; // å¾…å¤„ç†çš„äº¤æ˜“è¯·æ±‚

        // æ‰“å¼€äº¤æ˜“å¼¹çª—
        function openTradeModal() {
            if (gameState.players.length < 2) return;

            const player = gameState.players[gameState.currentPlayer];

            // å¡«å……äº¤æ˜“å¯¹è±¡é€‰æ‹©
            const targetSelect = document.getElementById('tradeTarget');
            targetSelect.innerHTML = '<option value="">é€‰æ‹©äº¤æ˜“å¯¹è±¡</option>';
            gameState.players.forEach((p, index) => {
                if (index !== gameState.currentPlayer) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = p.name;
                    targetSelect.appendChild(option);
                }
            });

            // é‡ç½®è¾“å…¥
            document.getElementById('tradeOfferMoney').value = 0;
            document.getElementById('tradeRequestMoney').value = 0;

            // å¡«å……æˆ‘çš„åœ°äº§
            const offerContainer = document.getElementById('tradeOfferProperties');
            offerContainer.innerHTML = '';
            if (player.properties.length === 0) {
                offerContainer.innerHTML = '<div style="color:#888;padding:10px;">æ— åœ°äº§</div>';
            } else {
                player.properties.forEach(propId => {
                    const cell = cells[propId];
                    const houseLevel = houseData[propId] || 0;
                    const houseIcon = houseLevel > 0 ? (houseLevel === 5 ? 'ğŸ¨' : 'ğŸ '.repeat(houseLevel)) : '';
                    const item = document.createElement('div');
                    item.className = 'trade-property-item';
                    item.innerHTML = `
                        <input type="checkbox" value="${propId}" id="offer_${propId}">
                        <label for="offer_${propId}" style="cursor:pointer;flex:1;">
                            ${cell.icon} ${cell.name} ${houseIcon}
                        </label>
                    `;
                    offerContainer.appendChild(item);
                });
            }

            // å¡«å……å¯¹æ–¹çš„åœ°äº§ï¼ˆå…ˆæ˜¾ç¤ºç©ºï¼Œç­‰é€‰æ‹©å¯¹è±¡åå†å¡«å……ï¼‰
            const requestContainer = document.getElementById('tradeRequestProperties');
            requestContainer.innerHTML = '<div style="color:#888;padding:10px;">è¯·å…ˆé€‰æ‹©äº¤æ˜“å¯¹è±¡</div>';

            // ç›‘å¬äº¤æ˜“å¯¹è±¡é€‰æ‹©
            targetSelect.onchange = function() {
                const targetIndex = parseInt(this.value);
                if (isNaN(targetIndex)) {
                    requestContainer.innerHTML = '<div style="color:#888;padding:10px;">è¯·å…ˆé€‰æ‹©äº¤æ˜“å¯¹è±¡</div>';
                    return;
                }

                const target = gameState.players[targetIndex];
                requestContainer.innerHTML = '';
                if (target.properties.length === 0) {
                    requestContainer.innerHTML = '<div style="color:#888;padding:10px;">å¯¹æ–¹æ— åœ°äº§</div>';
                } else {
                    target.properties.forEach(propId => {
                        const cell = cells[propId];
                        const houseLevel = houseData[propId] || 0;
                        const houseIcon = houseLevel > 0 ? (houseLevel === 5 ? 'ğŸ¨' : 'ğŸ '.repeat(houseLevel)) : '';
                        const item = document.createElement('div');
                        item.className = 'trade-property-item';
                        item.innerHTML = `
                            <input type="checkbox" value="${propId}" id="request_${propId}">
                            <label for="request_${propId}" style="cursor:pointer;flex:1;">
                                ${cell.icon} ${cell.name} ${houseIcon}
                            </label>
                        `;
                        requestContainer.appendChild(item);
                    });
                }
            };

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('tradeModal').style.display = 'flex';
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').style.display = 'none';
        }

        function closeTradeConfirmModal() {
            document.getElementById('tradeConfirmModal').style.display = 'none';
        }

        // æäº¤äº¤æ˜“æè®®
        function submitTradeOffer() {
            const targetIndex = parseInt(document.getElementById('tradeTarget').value);
            if (isNaN(targetIndex)) {
                alert('è¯·é€‰æ‹©äº¤æ˜“å¯¹è±¡ï¼');
                return;
            }

            const offerMoney = parseInt(document.getElementById('tradeOfferMoney').value) || 0;
            const requestMoney = parseInt(document.getElementById('tradeRequestMoney').value) || 0;

            // è·å–é€‰æ‹©çš„åœ°äº§
            const offerProperties = [];
            document.querySelectorAll('#tradeOfferProperties input[type="checkbox"]:checked').forEach(cb => {
                offerProperties.push(parseInt(cb.value));
            });

            const requestProperties = [];
            document.querySelectorAll('#tradeRequestProperties input[type="checkbox"]:checked').forEach(cb => {
                requestProperties.push(parseInt(cb.value));
            });

            const fromPlayer = gameState.players[gameState.currentPlayer];
            const toPlayer = gameState.players[targetIndex];

            // éªŒè¯èµ„é‡‘
            if (offerMoney > fromPlayer.money) {
                alert('ä½ çš„èµ„é‡‘ä¸è¶³ï¼');
                return;
            }

            // åˆ›å»ºäº¤æ˜“è¯·æ±‚
            pendingTrade = {
                from: gameState.currentPlayer,
                to: targetIndex,
                offerMoney: offerMoney,
                offerProperties: offerProperties,
                requestMoney: requestMoney,
                requestProperties: requestProperties
            };

            closeTradeModal();

            // å¦‚æœå¯¹æ–¹æ˜¯AIï¼Œè‡ªåŠ¨å¤„ç†
            if (toPlayer.isAI) {
                handleAITrade();
            } else {
                // æ˜¾ç¤ºäº¤æ˜“ç¡®è®¤å¼¹çª—ç»™å¯¹æ–¹
                showTradeConfirmModal();
            }
        }

        // æ˜¾ç¤ºäº¤æ˜“ç¡®è®¤ç•Œé¢
        function showTradeConfirmModal() {
            if (!pendingTrade) return;

            const fromPlayer = gameState.players[pendingTrade.from];
            const toPlayer = gameState.players[pendingTrade.to];

            // ç”Ÿæˆäº¤æ˜“è¯¦æƒ…HTML
            let detailsHTML = `
                <div class="trade-details-row">
                    <span>ğŸ§‘â€ğŸ’¼ å‘èµ·è€…:</span>
                    <span style="color:#FFD700;">${fromPlayer.name}</span>
                </div>
                <div class="trade-details-row">
                    <span>ğŸ¯ æ¥æ”¶è€…:</span>
                    <span style="color:#FFD700;">${toPlayer.name}</span>
                </div>
                <hr style="border-color:rgba(255,255,255,0.2);margin:15px 0;">
                <h4>ğŸ“¤ ${fromPlayer.name} æä¾›:</h4>
            `;

            if (pendingTrade.offerMoney > 0) {
                detailsHTML += `<div class="trade-details-row"><span>ğŸ’° ç°é‡‘:</span><span style="color:#4CAF50;">$${pendingTrade.offerMoney}</span></div>`;
            }

            if (pendingTrade.offerProperties.length > 0) {
                detailsHTML += `<div style="margin:10px 0;">ğŸ  åœ°äº§:</div>`;
                pendingTrade.offerProperties.forEach(propId => {
                    const cell = cells[propId];
                    const houseLevel = houseData[propId] || 0;
                    const houseIcon = houseLevel > 0 ? (houseLevel === 5 ? 'ğŸ¨' : 'ğŸ '.repeat(houseLevel)) : '';
                    detailsHTML += `<div style="padding:5px 10px;background:rgba(76,175,80,0.2);border-radius:4px;margin:4px 0;">${cell.icon} ${cell.name} ${houseIcon}</div>`;
                });
            }

            if (pendingTrade.offerMoney === 0 && pendingTrade.offerProperties.length === 0) {
                detailsHTML += `<div style="color:#888;">æ— </div>`;
            }

            detailsHTML += `<hr style="border-color:rgba(255,255,255,0.2);margin:15px 0;"><h4>ğŸ“¥ è¯·æ±‚:</h4>`;

            if (pendingTrade.requestMoney > 0) {
                detailsHTML += `<div class="trade-details-row"><span>ğŸ’° ç°é‡‘:</span><span style="color:#4CAF50;">$${pendingTrade.requestMoney}</span></div>`;
            }

            if (pendingTrade.requestProperties.length > 0) {
                detailsHTML += `<div style="margin:10px 0;">ğŸ  åœ°äº§:</div>`;
                pendingTrade.requestProperties.forEach(propId => {
                    const cell = cells[propId];
                    const houseLevel = houseData[propId] || 0;
                    const houseIcon = houseLevel > 0 ? (houseLevel === 5 ? 'ğŸ¨' : 'ğŸ '.repeat(houseLevel)) : '';
                    detailsHTML += `<div style="padding:5px 10px;background:rgba(255,152,0,0.2);border-radius:4px;margin:4px 0;">${cell.icon} ${cell.name} ${houseIcon}</div>`;
                });
            }

            if (pendingTrade.requestMoney === 0 && pendingTrade.requestProperties.length === 0) {
                detailsHTML += `<div style="color:#888;">æ— </div>`;
            }

            document.getElementById('tradeOfferDetails').innerHTML = detailsHTML;
            document.getElementById('tradeConfirmModal').style.display = 'flex';
        }

        // AIå¤„ç†äº¤æ˜“
        function handleAITrade() {
            if (!pendingTrade) return;

            const fromPlayer = gameState.players[pendingTrade.from];
            const toPlayer = gameState.players[pendingTrade.to];

            // AIç®€å•é€»è¾‘ï¼šè®¡ç®—æ€»ä»·å€¼ï¼Œå¦‚æœæ”¶ç›Šå¤§äºç­‰äºæ”¯å‡ºåˆ™æ¥å—
            let offerValue = pendingTrade.offerMoney;
            pendingTrade.offerProperties.forEach(propId => {
                const cell = cells[propId];
                offerValue += cell.price;
                // æˆ¿å±‹ä¹Ÿè®¡ç®—ä»·å€¼
                const houseLevel = houseData[propId] || 0;
                if (houseLevel > 0) {
                    offerValue += cell.houseCost * houseLevel;
                }
            });

            let requestValue = pendingTrade.requestMoney;
            pendingTrade.requestProperties.forEach(propId => {
                const cell = cells[propId];
                requestValue += cell.price;
                const houseLevel = houseData[propId] || 0;
                if (houseLevel > 0) {
                    requestValue += cell.houseCost * houseLevel;
                }
            });

            // AIæ¥å—æ¡ä»¶ï¼šæä¾›çš„ä»·å€¼ >= è¯·æ±‚çš„ä»·å€¼ * 1.2ï¼ˆè¦æœ‰20%åˆ©æ¶¦æ‰æ¥å—ï¼‰
            if (offerValue >= requestValue * 1.2) {
                executeTrade();
                showModal('äº¤æ˜“æˆåŠŸ', 'ğŸ¤', `${toPlayer.name} æ¥å—äº†ä½ çš„äº¤æ˜“æè®®ï¼\n\näº¤æ˜“å·²å®Œæˆã€‚`, 'win');
            } else {
                pendingTrade = null;
                showModal('äº¤æ˜“å¤±è´¥', 'âŒ', `${toPlayer.name} æ‹’ç»äº†ä½ çš„äº¤æ˜“æè®®ã€‚\n\n(AIè®¤ä¸ºæŠ¥ä»·ä¸å¤Ÿä¼˜æƒ )`, 'normal');
            }
        }

        // æ¥å—äº¤æ˜“
        function acceptTrade() {
            if (!pendingTrade) return;

            executeTrade();
            closeTradeConfirmModal();
            showModal('äº¤æ˜“æˆåŠŸ', 'ğŸ¤', 'äº¤æ˜“å·²å®Œæˆï¼', 'win');
        }

        // æ‹’ç»äº¤æ˜“
        function rejectTrade() {
            if (!pendingTrade) return;

            const fromPlayer = gameState.players[pendingTrade.from];
            addLog(`äº¤æ˜“è¯·æ±‚è¢« ${gameState.players[pendingTrade.to].name} æ‹’ç»`, 'system');

            pendingTrade = null;
            closeTradeConfirmModal();
        }

        // æ‰§è¡Œäº¤æ˜“
        function executeTrade() {
            if (!pendingTrade) return;

            const fromPlayer = gameState.players[pendingTrade.from];
            const toPlayer = gameState.players[pendingTrade.to];

            // è½¬ç§»èµ„é‡‘
            fromPlayer.money -= pendingTrade.offerMoney;
            toPlayer.money += pendingTrade.offerMoney;
            toPlayer.money -= pendingTrade.requestMoney;
            fromPlayer.money += pendingTrade.requestMoney;

            // è½¬ç§»åœ°äº§ (ä»å‘èµ·è€…åˆ°æ¥æ”¶è€…)
            pendingTrade.offerProperties.forEach(propId => {
                const idx = fromPlayer.properties.indexOf(propId);
                if (idx > -1) {
                    fromPlayer.properties.splice(idx, 1);
                    toPlayer.properties.push(propId);
                }
            });

            // è½¬ç§»åœ°äº§ (ä»æ¥æ”¶è€…åˆ°å‘èµ·è€…)
            pendingTrade.requestProperties.forEach(propId => {
                const idx = toPlayer.properties.indexOf(propId);
                if (idx > -1) {
                    toPlayer.properties.splice(idx, 1);
                    fromPlayer.properties.push(propId);
                }
            });

            addLog(`ğŸ¤ ${fromPlayer.name} ä¸ ${toPlayer.name} å®Œæˆäº†äº¤æ˜“ï¼`, 'event');

            // åˆ·æ–°ç•Œé¢
            createBoard();
            updatePlayerInfo();

            pendingTrade = null;
        }

        // ==================== äº¤æ˜“åŠŸèƒ½ç»“æŸ ====================

        function endTurn() {
            gameState.canBuy = false;
            gameState.canBuild = false;
            document.getElementById('buyBtn').disabled = true;
            document.getElementById('buildBtn').disabled = true;
            document.getElementById('tradeBtn').disabled = true;
            document.getElementById('endBtn').disabled = true;

            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸï¼ˆåªå‰©ä¸€ä¸ªç©å®¶æœ‰é’±ï¼‰
            const activePlayers = gameState.players.filter(p => p.money > 0 || p.properties.length > 0);
            if (activePlayers.length === 1) {
                const winner = activePlayers[0];
                gameState.gameOver = true;
                showModal('æ¸¸æˆç»“æŸ', 'ğŸ†', `${winner.name} è·èƒœï¼\n\næ­å–œæˆä¸ºæœ€å¯Œæœ‰çš„çŸ¿å·¥ï¼`, 'win');
                return;
            }

            // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæœ‰èµ„é‡‘çš„ç©å®¶
            let nextPlayerIndex = (gameState.currentPlayer + 1) % gameState.players.length;
            let loopCount = 0;

            // è·³è¿‡ç ´äº§çš„ç©å®¶
            while ((gameState.players[nextPlayerIndex].money <= 0 && gameState.players[nextPlayerIndex].properties.length === 0) && loopCount < gameState.players.length) {
                nextPlayerIndex = (nextPlayerIndex + 1) % gameState.players.length;
                loopCount++;
            }

            gameState.currentPlayer = nextPlayerIndex;
            updatePlayerInfo();

            const nextPlayer = gameState.players[gameState.currentPlayer];
            addLog(`è½®åˆ° ${nextPlayer.name}`, 'system');

            if (!nextPlayer.isAI) {
                document.getElementById('rollBtn').disabled = false;
            } else {
                setTimeout(aiTurn, 1200);
            }
        }

        async function aiTurn() {
            if (gameState.gameOver) return;

            const player = gameState.players[gameState.currentPlayer];
            if (!player.isAI) return;

            // AIæ·éª°å­
            document.getElementById('rollBtn').disabled = true;

            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');

            dice1.classList.add('rolling');
            dice2.classList.add('rolling');

            await sleep(600);

            gameState.dice[0] = Math.floor(Math.random() * 6) + 1;
            gameState.dice[1] = Math.floor(Math.random() * 6) + 1;

            dice1.classList.remove('rolling');
            dice2.classList.remove('rolling');

            dice1.textContent = getDiceIcon(gameState.dice[0]);
            dice2.textContent = getDiceIcon(gameState.dice[1]);

            const total = gameState.dice[0] + gameState.dice[1];
            addLog(`${player.name} æ·å‡ºäº† ${total} ç‚¹ (${gameState.dice[0]}+${gameState.dice[1]})`, player.class);

            await movePlayer(gameState.currentPlayer, total);
            await handleCellEvent(gameState.currentPlayer);

            updatePlayerInfo();

            if (!gameState.gameOver) {
                // AIè´­ä¹°é€»è¾‘
                if (gameState.canBuy && player.money > 300) {
                    await sleep(800);
                    buyProperty();
                }

                // AIå»ºé€ æˆ¿å±‹é€»è¾‘
                if (gameState.canBuild) {
                    const cell = cells[player.position];
                    if (player.money > cell.houseCost * 2) {
                        await sleep(800);
                        buildHouse();
                    }
                }

                await sleep(1000);
                endTurn();
            }
        }

        function handleBankruptcy(playerIndex) {
            const player = gameState.players[playerIndex];

            addLog(`ğŸ’” ${player.name} ç ´äº§äº†ï¼`, player.class);

            // ç ´äº§ç©å®¶æ‰€æœ‰åœ°äº§å˜ä¸ºæ— ä¸»çŠ¶æ€ï¼ˆæˆ¿å±‹æ¸…é›¶ï¼‰
            player.properties.forEach(propId => {
                houseData[propId] = 0; // æ¸…ç©ºæˆ¿å±‹
            });
            player.properties = []; // æ¸…ç©ºåœ°äº§
            player.money = 0; // èµ„é‡‘æ¸…é›¶

            // åˆ·æ–°æ£‹ç›˜æ˜¾ç¤º
            createBoard();
            updatePlayerInfo();

            // æ£€æŸ¥å‰©ä½™æ´»è·ƒç©å®¶æ•°é‡
            const activePlayers = gameState.players.filter(p => p.money > 0);

            if (activePlayers.length <= 1) {
                // æ¸¸æˆç»“æŸ
                gameState.gameOver = true;
                const winner = activePlayers[0];
                showModal('æ¸¸æˆç»“æŸ', 'ğŸ†', `${winner.name} è·èƒœï¼\n\næ­å–œæˆä¸ºæœ€å¯Œæœ‰çš„çŸ¿å·¥ï¼\n\næ¸¸æˆç»“æŸæ–¹å¼ï¼šå…¶ä»–ç©å®¶å…¨éƒ¨ç ´äº§`, 'win');
            } else {
                // æ¸¸æˆç»§ç»­ï¼Œè·³è¿‡ç ´äº§ç©å®¶
                showModal('ç©å®¶ç ´äº§', 'ğŸ’”', `${player.name} å·²ç ´äº§ï¼\n\nå…¶æ‰€æœ‰åœ°äº§å·²è¢«é“¶è¡Œæ”¶å›ã€‚\næ¸¸æˆç»§ç»­...`, 'normal');

                // å¦‚æœå½“å‰æ˜¯ç ´äº§ç©å®¶çš„å›åˆï¼Œè‡ªåŠ¨ç»“æŸå›åˆ
                if (gameState.currentPlayer === playerIndex) {
                    setTimeout(() => {
                        endTurn();
                    }, 2000);
                }
            }
        }

        function showModal(title, icon, text, type) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalText').textContent = text;
            document.getElementById('modalContent').className = `modal-content ${type}`;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function addLog(message, type) {
            const log = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.textContent = `[${time}] ${message}`;

            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function createParticles(element) {
            const rect = element.getBoundingClientRect();
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];

            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = rect.left + rect.width / 2 + 'px';
                particle.style.top = rect.top + rect.height / 2 + 'px';
                particle.style.width = '10px';
                particle.style.height = '10px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.borderRadius = '50%';
                particle.style.transition = 'all 1s ease-out';
                document.body.appendChild(particle);

                setTimeout(() => {
                    const angle = (Math.PI * 2 * i) / 20;
                    const distance = 50 + Math.random() * 100;
                    particle.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0)`;
                    particle.style.opacity = '0';
                }, 10);

                setTimeout(() => particle.remove(), 1000);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showRules() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('rulesPage').style.display = 'block';
        }

        function hideRules() {
            document.getElementById('rulesPage').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆ›å»ºæ£‹ç›˜
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (document.getElementById('gameArea').style.display !== 'none') {
                    createBoard();
                }
            }, 250);
        });

        // åˆå§‹åŒ–
        createStars();
    </script>
</body>
</html>
